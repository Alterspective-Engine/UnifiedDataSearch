<!DOCTYPE html>
<html>
<head>
    <title>Test Inline Search API Calls</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .api-response {
            background: #f5f5f5;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        input {
            padding: 8px;
            width: 300px;
            margin-right: 10px;
        }
        .status {
            font-weight: bold;
            margin-top: 10px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Test Inline Search API Calls</h1>
    
    <div class="test-section">
        <h2>1. Test ShareDo ODS API - POST /api/ods/_search</h2>
        <input type="text" id="searchQuery" placeholder="Enter search query (e.g., 'igor')" value="igor">
        <button onclick="testOdsSearch()">Test ODS Search</button>
        <div class="status" id="odsStatus"></div>
        <div class="api-response" id="odsResponse"></div>
    </div>

    <div class="test-section">
        <h2>2. Test with Inline Search Payload Structure</h2>
        <input type="text" id="inlineQuery" placeholder="Enter search query" value="igor">
        <select id="entityType">
            <option value="all">All</option>
            <option value="person">Person Only</option>
            <option value="organisation">Organisation Only</option>
        </select>
        <button onclick="testInlineSearchPayload()">Test Inline Search</button>
        <div class="status" id="inlineStatus"></div>
        <div class="api-response" id="inlineResponse"></div>
    </div>

    <div class="test-section">
        <h2>3. Network Activity Monitor</h2>
        <p>Open browser DevTools â†’ Network tab to see actual API calls</p>
        <div id="networkLog"></div>
    </div>

    <script>
    // Configure jQuery ajax to use ShareDo's $ajax if available
    if (typeof window.$ajax !== 'undefined') {
        console.log('Using ShareDo $ajax');
    } else {
        console.log('Using jQuery $.ajax');
        window.$ajax = $.ajax;
    }

    function testOdsSearch() {
        var query = $('#searchQuery').val();
        $('#odsStatus').text('Searching...').removeClass().addClass('status info');
        
        // Build the same payload structure used in blade
        var payload = {
            query: query,
            page: 0,
            pageSize: 5,
            searchType: "quick",
            searchParticipants: {
                enabled: false
            },
            searchOds: {
                enabled: true,
                associatedWithMatterOwner: false,
                label: null,
                otherOdsIds: []
            },
            competencies: [],
            teams: [],
            roles: [],
            odsTypes: [],
            wallManagement: false,
            odsEntityTypes: ["person", "organisation"]
        };
        
        console.log('Sending ODS search request:', payload);
        
        $.ajax({
            url: '/api/ods/_search',
            method: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            dataType: 'json',
            success: function(data) {
                $('#odsStatus').text('Success! Found ' + (data.totalRows || 0) + ' results').removeClass().addClass('status success');
                $('#odsResponse').text(JSON.stringify(data, null, 2));
                
                // Parse and display results
                if (data.rows && data.rows.length > 0) {
                    console.log('ODS Results:');
                    data.rows.forEach(function(row) {
                        try {
                            var entity = JSON.parse(row.result);
                            console.log('- ' + (entity.firstName || '') + ' ' + (entity.lastName || entity.name || ''));
                        } catch(e) {
                            console.error('Failed to parse row:', e);
                        }
                    });
                }
            },
            error: function(xhr, status, error) {
                $('#odsStatus').text('Error: ' + error).removeClass().addClass('status error');
                $('#odsResponse').text('Status: ' + xhr.status + '\n' + xhr.responseText);
            }
        });
    }

    function testInlineSearchPayload() {
        var query = $('#inlineQuery').val();
        var entityType = $('#entityType').val();
        $('#inlineStatus').text('Searching...').removeClass().addClass('status info');
        
        // Build the exact payload structure from inline search
        var payload = {
            query: query || "",
            page: 0,
            pageSize: 5,
            searchType: "quick",
            searchParticipants: {
                enabled: false
            },
            searchOds: {
                enabled: true,
                associatedWithMatterOwner: false,
                label: null,
                otherOdsIds: []
            },
            competencies: [],
            teams: [],
            roles: [],
            odsTypes: [],
            wallManagement: false
        };
        
        // Add entity type filter
        if (entityType === "person") {
            payload.odsEntityTypes = ["person"];
        } else if (entityType === "organisation") {
            payload.odsEntityTypes = ["organisation"];
        } else {
            payload.odsEntityTypes = ["person", "organisation"];
        }
        
        console.log('Sending inline search request:', payload);
        $('#networkLog').append('<div>API Call: POST /api/ods/_search at ' + new Date().toLocaleTimeString() + '</div>');
        
        $.ajax({
            url: '/api/ods/_search',
            method: 'POST',
            data: JSON.stringify(payload),
            contentType: 'application/json',
            dataType: 'json',
            success: function(data) {
                $('#inlineStatus').text('Success! Found ' + (data.totalRows || 0) + ' results').removeClass().addClass('status success');
                
                // Process results like inline search does
                var results = [];
                if (data.rows && Array.isArray(data.rows)) {
                    data.rows.forEach(function(row) {
                        try {
                            var entity = JSON.parse(row.result);
                            entity.id = entity.id || row.id;
                            entity.odsId = entity.id || row.id;
                            
                            // Extract contact details
                            if (entity.aspectData && entity.aspectData.ContactDetails) {
                                var contacts = entity.aspectData.ContactDetails;
                                var emailContact = contacts.find(function(c) {
                                    return c.contactTypeSystemName === "email";
                                });
                                if (emailContact) {
                                    entity.email = emailContact.contactValue;
                                }
                                
                                var phoneContact = contacts.find(function(c) {
                                    return c.contactTypeSystemName === "mobile" || 
                                           c.contactTypeSystemName === "direct-line" ||
                                           c.contactTypeSystemName === "phone";
                                });
                                if (phoneContact) {
                                    entity.phone = phoneContact.contactValue;
                                }
                            }
                            
                            results.push({
                                id: entity.id,
                                name: entity.firstName ? entity.firstName + ' ' + entity.lastName : entity.name,
                                email: entity.email || 'N/A',
                                phone: entity.phone || 'N/A',
                                type: entity.odsEntityType || (entity.firstName ? 'person' : 'organisation')
                            });
                        } catch(e) {
                            console.error('Failed to parse row:', e);
                        }
                    });
                }
                
                var displayText = 'Parsed Results:\n' + JSON.stringify(results, null, 2);
                displayText += '\n\n--- Raw Response ---\n' + JSON.stringify(data, null, 2);
                $('#inlineResponse').text(displayText);
            },
            error: function(xhr, status, error) {
                $('#inlineStatus').text('Error: ' + error).removeClass().addClass('status error');
                $('#inlineResponse').text('Status: ' + xhr.status + '\n' + xhr.responseText);
                $('#networkLog').append('<div style="color:red">API Error: ' + xhr.status + ' at ' + new Date().toLocaleTimeString() + '</div>');
            }
        });
    }

    // Test on page load with default query
    $(document).ready(function() {
        console.log('Test page ready. Use the buttons to test API calls.');
        console.log('Watch the Network tab in DevTools to see actual requests.');
    });
    </script>
</body>
</html>