<!DOCTYPE html>
<html>
<head>
    <title>Debug External Search</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ” External Search Debug Tool</h1>
    
    <div class="debug">
        <h3>Instructions:</h3>
        <ol>
            <li>Open your browser's Developer Tools (F12)</li>
            <li>Go to the Console tab</li>
            <li>Look for debug messages with emojis (ğŸ”, âœ…, âŒ, ğŸ“¡, etc.)</li>
            <li>Click the button below to test external search</li>
        </ol>
    </div>
    
    <button onclick="testExternalSearch()" style="padding: 10px 20px; font-size: 16px;">
        ğŸ§ª Test External Search Flow
    </button>
    
    <div id="results" class="debug" style="display:none;">
        <h3>Results:</h3>
        <pre id="output"></pre>
    </div>

    <!-- Include the actual services for testing -->
    <script src="Helpers/namespace.js"></script>
    <script src="Services/SearchApiService.js"></script>
    <script src="Services/UnifiedSearchService.js"></script>
    <script src="Services/ResultMergerService.js"></script>
    <script src="Services/OdsImportService.js"></script>
    
    <script>
        // Mock jQuery and ShareDo environment for testing
        window.$ = {
            Deferred: function() {
                var callbacks = { done: [], fail: [], always: [] };
                var state = 'pending';
                var result;
                
                var deferred = {
                    resolve: function(data) {
                        state = 'resolved';
                        result = data;
                        callbacks.done.forEach(cb => cb(data));
                        callbacks.always.forEach(cb => cb(data));
                        return this;
                    },
                    reject: function(error) {
                        state = 'rejected';
                        result = error;
                        callbacks.fail.forEach(cb => cb(error));
                        callbacks.always.forEach(cb => cb(error));
                        return this;
                    },
                    done: function(callback) {
                        if (state === 'resolved') callback(result);
                        else callbacks.done.push(callback);
                        return this;
                    },
                    fail: function(callback) {
                        if (state === 'rejected') callback(result);
                        else callbacks.fail.push(callback);
                        return this;
                    },
                    always: function(callback) {
                        if (state !== 'pending') callback(result);
                        else callbacks.always.push(callback);
                        return this;
                    },
                    promise: function() { return this; }
                };
                return deferred;
            },
            extend: function(target, ...sources) {
                sources.forEach(source => Object.assign(target, source));
                return target;
            },
            when: {
                apply: function($, promises) {
                    return promises.length === 0 ? $.Deferred().resolve().promise() :
                           Promise.all(promises.map(p => p.promise ? p.promise() : p));
                }
            }
        };

        // Mock $ajax service
        window.$ajax = {
            get: function(url) {
                console.log("ğŸŒ MOCK $ajax.get called:", url);
                var deferred = $.Deferred();
                
                // Simulate API responses based on URL
                setTimeout(() => {
                    if (url.includes('/isEnabled')) {
                        console.log("ğŸ”§ MOCK: External search is enabled");
                        deferred.resolve({ isEnabled: true });
                    } else if (url.includes('/providers/enabled')) {
                        console.log("ğŸ”§ MOCK: Returning mock providers");
                        deferred.resolve([
                            {
                                systemName: "affinity-external-ods-search",
                                displayName: "Affinity PMS",
                                canSearchPeople: true,
                                canSearchOrganisations: true
                            }
                        ]);
                    } else if (url.includes('/providers/')) {
                        console.log("ğŸ”§ MOCK: Returning mock search results");
                        deferred.resolve({
                            totalResults: 2,
                            rowsPerPage: 10,
                            currentPage: 0,
                            results: [
                                {
                                    providersReference: "MOCK123",
                                    firstName: "John",
                                    surname: "Doe",
                                    contactDetails: [
                                        { contactTypeSystemName: "email", contactValue: "john.doe@example.com" }
                                    ]
                                },
                                {
                                    providersReference: "MOCK456", 
                                    name: "Acme Corp",
                                    contactDetails: [
                                        { contactTypeSystemName: "phone", contactValue: "+61-2-1234-5678" }
                                    ]
                                }
                            ]
                        });
                    } else {
                        console.log("ğŸ”§ MOCK: Unknown URL, rejecting");
                        deferred.reject({ status: 404, responseText: "Not found" });
                    }
                }, 100); // Small delay to simulate network
                
                return deferred;
            },
            post: function(url, data) {
                console.log("ğŸŒ MOCK $ajax.post called:", url, data);
                var deferred = $.Deferred();
                setTimeout(() => {
                    if (url.includes('/_search')) {
                        deferred.resolve({
                            rows: [
                                {
                                    id: "ods123",
                                    odsEntityType: "person", 
                                    result: JSON.stringify({
                                        id: "ods123",
                                        firstName: "Jane",
                                        surname: "Smith",
                                        aspectData: {
                                            ContactDetails: [
                                                { contactTypeSystemName: "email", contactValue: "jane.smith@example.com" }
                                            ]
                                        }
                                    })
                                }
                            ],
                            totalRows: 1
                        });
                    }
                }, 50);
                return deferred;
            }
        };

        function testExternalSearch() {
            console.log("ğŸ§ª === STARTING EXTERNAL SEARCH DEBUG TEST ===");
            
            // Show results div
            document.getElementById('results').style.display = 'block';
            document.getElementById('output').textContent = 'Testing... check console for detailed logs';
            
            // Test the external search flow
            try {
                console.log("ğŸ”§ Checking service availability...");
                
                // Check if services are loaded
                var searchApiService = Alt.UnifiedDataSearch.Services.getSearchApiService();
                var unifiedSearchService = Alt.UnifiedDataSearch.Services.unifiedSearchService;
                
                console.log("ğŸ“‹ Service Status:");
                console.log("  SearchApiService:", searchApiService ? "âœ… Available" : "âŒ Missing");
                console.log("  UnifiedSearchService:", unifiedSearchService ? "âœ… Available" : "âŒ Missing");
                
                if (!searchApiService) {
                    throw new Error("SearchApiService not available");
                }
                
                if (!unifiedSearchService) {
                    throw new Error("UnifiedSearchService not available");
                }
                
                // Create a test config
                var testConfig = {
                    query: "igor",
                    entityType: "person",
                    pageSize: 10,
                    page: 0,
                    timeout: 5000,
                    onOdsComplete: function(results) {
                        console.log("ğŸ¯ ODS search callback:", results);
                        updateOutput("ODS search completed: " + (results.results ? results.results.length : 0) + " results");
                    },
                    onPmsComplete: function(results) {
                        console.log("ğŸ¯ External search callback:", results);
                        updateOutput("External search completed: " + (results.results ? results.results.length : 0) + " results");
                    }
                };
                
                console.log("ğŸ§ª Test config:", testConfig);
                console.log("ğŸš€ Starting unified search test...");
                
                updateOutput("ğŸš€ Starting external search test...\n\nConfiguration:\n" + JSON.stringify(testConfig, null, 2));
                
                // Test individual components first
                console.log("ğŸ“¡ Testing individual components...");
                
                // Test 1: Check external search enabled
                console.log("ğŸ” Test 1: Checking if external search is enabled...");
                searchApiService.checkExternalSearchEnabled()
                    .done(function(response) {
                        console.log("âœ… External search enabled check result:", response);
                        updateOutput(updateOutput.lastText + "\n\nâœ… External search enabled: " + (response.isEnabled ? "YES" : "NO"));
                        
                        if (response.isEnabled) {
                            // Test 2: Get providers
                            console.log("ğŸ” Test 2: Getting external providers...");
                            return searchApiService.getEnabledExternalProviders();
                        } else {
                            updateOutput(updateOutput.lastText + "\nâŒ External search is disabled, cannot continue");
                            return $.Deferred().reject("External search disabled").promise();
                        }
                    })
                    .then(function(providers) {
                        console.log("âœ… External providers result:", providers);
                        updateOutput(updateOutput.lastText + "\n\nâœ… Found " + (providers ? providers.length : 0) + " external providers:");
                        
                        if (providers && providers.length > 0) {
                            providers.forEach(function(provider, index) {
                                updateOutput(updateOutput.lastText + "\n  " + (index + 1) + ". " + provider.systemName + 
                                           " (People: " + provider.canSearchPeople + ", Orgs: " + provider.canSearchOrganisations + ")");
                            });
                            
                            // Test 3: Execute unified search
                            console.log("ğŸ” Test 3: Executing unified search...");
                            updateOutput(updateOutput.lastText + "\n\nğŸš€ Executing unified search...");
                            return unifiedSearchService.search(testConfig);
                        } else {
                            updateOutput(updateOutput.lastText + "\nâŒ No external providers available");
                            return $.Deferred().reject("No providers available").promise();
                        }
                    })
                    .then(function(unifiedResults) {
                        console.log("âœ… Unified search complete:", unifiedResults);
                        updateOutput(updateOutput.lastText + "\n\nğŸ‰ UNIFIED SEARCH COMPLETE!");
                        updateOutput(updateOutput.lastText + "\n  Total results: " + (unifiedResults.totalCount || 0));
                        updateOutput(updateOutput.lastText + "\n  ODS count: " + (unifiedResults.odsCount || 0));
                        updateOutput(updateOutput.lastText + "\n  External count: " + (unifiedResults.externalCount || unifiedResults.pmsCount || 0));
                        
                        if (unifiedResults.results && unifiedResults.results.length > 0) {
                            updateOutput(updateOutput.lastText + "\n\nğŸ“‹ Sample results:");
                            unifiedResults.results.slice(0, 3).forEach(function(result, index) {
                                updateOutput(updateOutput.lastText + "\n  " + (index + 1) + ". " + 
                                           (result.displayName || "Unknown") + " (" + result.source + ")");
                            });
                        }
                    })
                    .fail(function(error) {
                        console.error("âŒ External search test failed:", error);
                        updateOutput(updateOutput.lastText + "\n\nâŒ External search test FAILED: " + (error.message || error));
                    });
                
            } catch (error) {
                console.error("âŒ Test setup failed:", error);
                updateOutput('âŒ Test setup failed: ' + error.message);
            }
        }
        
        function updateOutput(text) {
            updateOutput.lastText = text;
            document.getElementById('output').textContent = text;
        }
        updateOutput.lastText = "";
        
        console.log("ğŸ”§ External Search Debug Tool loaded");
        console.log("   Click the test button to simulate the external search flow");
        console.log("   This will help identify where the external search calls stop");
    </script>
</body>
</html>