<!DOCTYPE html>
<html>
<head>
    <title>Test UnifiedOdsEntityPicker Widget</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .widget-container {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .config-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .status-display {
            margin-top: 15px;
            padding: 10px;
            background: #e7f5ff;
            border: 1px solid #339af0;
            border-radius: 4px;
        }
        
        .test-controls {
            margin-top: 15px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 4px;
        }
        
        .test-controls button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>UnifiedOdsEntityPicker Widget Test Page</h1>
        <p class="lead">Test different configurations of the UnifiedOdsEntityPicker widget</p>
        
        <!-- Test 1: Simple Mode - Single Selection -->
        <div class="test-section">
            <h2>Test 1: Simple Mode - Single Selection</h2>
            <p>Basic entity picker with single selection, using our custom UI.</p>
            
            <div class="widget-container" id="test1-widget">
                <!-- Widget will be initialized here -->
            </div>
            
            <div class="config-display">
Configuration:
{
    "label": "Select Client",
    "placeholder": "Click to search for a client...",
    "required": true,
    "allowMultiple": false,
    "mode": "auto",
    "useMockPms": true,
    "showEmail": true,
    "showPhone": true,
    "showSource": true
}
            </div>
            
            <div class="status-display" id="test1-status">
                <strong>Selected Entity:</strong> <span id="test1-value">None</span>
            </div>
        </div>
        
        <!-- Test 2: Simple Mode - Multiple Selection -->
        <div class="test-section">
            <h2>Test 2: Simple Mode - Multiple Selection</h2>
            <p>Entity picker allowing multiple selections with clear all option.</p>
            
            <div class="widget-container" id="test2-widget">
                <!-- Widget will be initialized here -->
            </div>
            
            <div class="config-display">
Configuration:
{
    "label": "Select Participants",
    "placeholder": "Click to add participants...",
    "required": false,
    "allowMultiple": true,
    "allowClear": true,
    "mode": "select",
    "entityTypes": ["person"],
    "showIcon": true,
    "showSource": true
}
            </div>
            
            <div class="status-display" id="test2-status">
                <strong>Selected Entities:</strong> <span id="test2-value">None</span>
            </div>
        </div>
        
        <!-- Test 3: Component Mode (if available) -->
        <div class="test-section">
            <h2>Test 3: ShareDo Component Mode</h2>
            <p>Uses ShareDo OdsEntityPicker component for display with our search override.</p>
            
            <div class="widget-container" id="test3-widget">
                <!-- Widget will be initialized here -->
            </div>
            
            <div class="config-display">
Configuration:
{
    "useShareDoComponent": true,
    "displayMode": "component",
    "roleSystemName": "client",
    "roleLabel": "Client",
    "viewMode": "card",
    "required": true,
    "mode": "auto",
    "bladeName": "Alt.UnifiedDataSearch.Blades.UnifiedOdsPmsSearch"
}
            </div>
            
            <div class="status-display" id="test3-status">
                <strong>Note:</strong> This mode requires ShareDo component to be available.
            </div>
        </div>
        
        <!-- Test 4: Aspect Widget Simulation -->
        <div class="test-section">
            <h2>Test 4: Aspect Widget Mode</h2>
            <p>Simulates usage as an aspect widget with host model binding.</p>
            
            <div class="widget-container" id="test4-widget">
                <!-- Widget will be initialized here -->
            </div>
            
            <div class="config-display">
Configuration:
{
    "_host": {
        "model": mockHostModel,
        "blade": null,
        "enabled": true
    },
    "fieldName": "clientOdsId",
    "returnField": "odsId",
    "label": "Primary Client",
    "required": true,
    "mode": "auto"
}
            </div>
            
            <div class="status-display" id="test4-status">
                <strong>Host Model Value:</strong> <span id="test4-value">None</span>
            </div>
            
            <div class="test-controls">
                <h5>Test Controls:</h5>
                <button class="btn btn-sm btn-primary" onclick="setHostValue('ODS-P001')">
                    Set Host Value to ODS-P001
                </button>
                <button class="btn btn-sm btn-primary" onclick="setHostValue(null)">
                    Clear Host Value
                </button>
                <button class="btn btn-sm btn-warning" onclick="toggleEnabled()">
                    Toggle Enabled State
                </button>
                <button class="btn btn-sm btn-success" onclick="validateWidget()">
                    Validate Widget
                </button>
                <button class="btn btn-sm btn-info" onclick="saveWidget()">
                    Trigger Save
                </button>
            </div>
        </div>
        
        <!-- Test 5: Search Mode Tests -->
        <div class="test-section">
            <h2>Test 5: Search Mode Variations</h2>
            <p>Test different search configurations.</p>
            
            <div class="row">
                <div class="col-md-4">
                    <h5>ODS Only</h5>
                    <div class="widget-container" id="test5a-widget"></div>
                    <small>searchMode: "odsOnly"</small>
                </div>
                <div class="col-md-4">
                    <h5>PMS Only</h5>
                    <div class="widget-container" id="test5b-widget"></div>
                    <small>searchMode: "pmsOnly"</small>
                </div>
                <div class="col-md-4">
                    <h5>Unified (Default)</h5>
                    <div class="widget-container" id="test5c-widget"></div>
                    <small>searchMode: "unified"</small>
                </div>
            </div>
        </div>
        
        <!-- Console Output -->
        <div class="test-section">
            <h2>Console Output</h2>
            <div id="console-output" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto;">
                <div>// Console output will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js"></script>
    
    <script>
        // Mock implementations for testing
        window.$ui = window.$ui || {
            stacks: {
                openPanel: function(bladeName, config) {
                    console.log("Opening blade:", bladeName, config);
                    logToConsole("Opening blade: " + bladeName);
                    
                    // Simulate blade result
                    return {
                        closed: {
                            then: function(callback) {
                                setTimeout(function() {
                                    // Simulate entity selection
                                    var mockEntity = {
                                        odsId: "ODS-" + Math.random().toString(36).substr(2, 9),
                                        firstName: "John",
                                        lastName: "Doe",
                                        email: "john.doe@example.com",
                                        phone: "0412345678",
                                        source: "pms"
                                    };
                                    
                                    callback({ selectedEntity: mockEntity });
                                    logToConsole("Entity selected: " + JSON.stringify(mockEntity));
                                }, 1000);
                            }
                        }
                    };
                }
            },
            events: {
                publish: function(eventName, data) {
                    console.log("Event published:", eventName, data);
                    logToConsole("Event: " + eventName);
                },
                subscribe: function(eventName, callback, context) {
                    console.log("Event subscribed:", eventName);
                    return "subscription-" + Math.random();
                }
            }
        };
        
        window.$ajax = window.$ajax || {
            get: function(url, params) {
                console.log("AJAX GET:", url, params);
                logToConsole("AJAX GET: " + url);
                
                // Mock response
                return $.Deferred().resolve({
                    id: "ODS-P001",
                    firstName: "Mock",
                    lastName: "Entity",
                    email: "mock@example.com"
                }).promise();
            },
            post: function(url, data) {
                console.log("AJAX POST:", url, data);
                logToConsole("AJAX POST: " + url);
                
                return $.Deferred().resolve({
                    id: "ODS-NEW-" + Math.random().toString(36).substr(2, 9)
                }).promise();
            }
        };
        
        // Mock host model for aspect widget test
        var mockHostModel = {
            clientOdsId: ko.observable(null),
            title: ko.observable("Test Work Item")
        };
        
        // Widget instances
        var widgets = {};
        
        // Initialize widgets when page loads
        $(document).ready(function() {
            // Load widget files
            loadWidgetFiles().then(function() {
                initializeWidgets();
            });
        });
        
        function loadWidgetFiles() {
            // In a real environment, these would be loaded by the ShareDo framework
            // For testing, we'll load them manually
            var deferred = $.Deferred();
            
            // Load namespace helper
            $.getScript("/_ideFiles/Alt/UnifiedDataSearch/Helpers/namespace.js")
                .done(function() {
                    // Load services
                    $.when(
                        $.getScript("/_ideFiles/Alt/UnifiedDataSearch/Services/MockPmsService.js"),
                        $.getScript("/_ideFiles/Alt/UnifiedDataSearch/Services/ResultMergerService.js")
                    ).done(function() {
                        // Load widget
                        $.getScript("/_ideFiles/Alt/UnifiedDataSearch/Widgets/UnifiedOdsEntityPicker/UnifiedOdsEntityPicker.js")
                            .done(function() {
                                deferred.resolve();
                            })
                            .fail(function() {
                                console.error("Failed to load widget script");
                                deferred.reject();
                            });
                    });
                })
                .fail(function() {
                    console.error("Failed to load namespace helper");
                    
                    // Try to continue without it
                    if (typeof window.namespace === 'undefined') {
                        window.namespace = function(ns) {
                            var parts = ns.split('.');
                            var parent = window;
                            for (var i = 0; i < parts.length; i++) {
                                if (typeof parent[parts[i]] === 'undefined') {
                                    parent[parts[i]] = {};
                                }
                                parent = parent[parts[i]];
                            }
                            return parent;
                        };
                    }
                    deferred.resolve();
                });
            
            return deferred.promise();
        }
        
        function initializeWidgets() {
            // Test 1: Simple Single Selection
            widgets.test1 = createWidget("test1-widget", {
                label: "Select Client",
                placeholder: "Click to search for a client...",
                required: true,
                allowMultiple: false,
                mode: "auto",
                useMockPms: true,
                showEmail: true,
                showPhone: true,
                showSource: true
            });
            
            // Test 2: Multiple Selection
            widgets.test2 = createWidget("test2-widget", {
                label: "Select Participants",
                placeholder: "Click to add participants...",
                required: false,
                allowMultiple: true,
                allowClear: true,
                mode: "select",
                entityTypes: ["person"],
                showIcon: true,
                showSource: true
            });
            
            // Test 3: Component Mode
            widgets.test3 = createWidget("test3-widget", {
                useShareDoComponent: true,
                displayMode: "component",
                roleSystemName: "client",
                roleLabel: "Client",
                viewMode: "card",
                required: true,
                mode: "auto"
            });
            
            // Test 4: Aspect Widget Mode
            widgets.test4 = createWidget("test4-widget", {
                _host: {
                    model: mockHostModel,
                    blade: null,
                    enabled: ko.observable(true)
                },
                fieldName: "clientOdsId",
                returnField: "odsId",
                label: "Primary Client",
                required: true,
                mode: "auto"
            });
            
            // Test 5: Search Modes
            widgets.test5a = createWidget("test5a-widget", {
                searchMode: "odsOnly",
                placeholder: "ODS only...",
                showSource: true
            });
            
            widgets.test5b = createWidget("test5b-widget", {
                searchMode: "pmsOnly",
                placeholder: "PMS only...",
                showSource: true
            });
            
            widgets.test5c = createWidget("test5c-widget", {
                searchMode: "unified",
                placeholder: "Unified search...",
                showSource: true
            });
            
            // Subscribe to value changes
            subscribeToChanges();
        }
        
        function createWidget(elementId, config) {
            var element = document.getElementById(elementId);
            if (!element) {
                console.error("Element not found:", elementId);
                return null;
            }
            
            // Check if widget constructor exists
            if (typeof Alt === 'undefined' || !Alt.UnifiedDataSearch || !Alt.UnifiedDataSearch.Widgets) {
                console.error("Widget not loaded properly");
                
                // Create placeholder
                element.innerHTML = '<div class="alert alert-warning">Widget not loaded. Check console for errors.</div>';
                return null;
            }
            
            try {
                var widget = new Alt.UnifiedDataSearch.Widgets.UnifiedOdsEntityPicker(
                    element,
                    config,
                    { id: elementId }
                );
                
                // Load widget template
                loadWidgetTemplate(element);
                
                // Apply Knockout bindings
                ko.applyBindings(widget, element);
                
                // Call loadAndBind
                if (widget.loadAndBind) {
                    widget.loadAndBind();
                }
                
                logToConsole("Widget initialized: " + elementId);
                return widget;
            } catch (error) {
                console.error("Error creating widget:", error);
                element.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                return null;
            }
        }
        
        function loadWidgetTemplate(element) {
            // Load the widget HTML template
            // In production, this would be loaded by the framework
            $.get("/_ideFiles/Alt/UnifiedDataSearch/Widgets/UnifiedOdsEntityPicker/UnifiedOdsEntityPicker.html")
                .done(function(html) {
                    element.innerHTML = html;
                })
                .fail(function() {
                    // Use inline template as fallback
                    element.innerHTML = `
                        <div class="Alt-UnifiedDataSearch-Widgets-UnifiedOdsEntityPicker">
                            <div class="entity-picker-container">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control"
                                           readonly="readonly"
                                           data-bind="value: displayValue, 
                                                      attr: { placeholder: options.placeholder },
                                                      click: openSearchBlade" />
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary"
                                                data-bind="click: openSearchBlade">
                                            <i class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }
        
        function subscribeToChanges() {
            // Subscribe to test 1 changes
            if (widgets.test1 && widgets.test1.selectedEntity) {
                widgets.test1.selectedEntity.subscribe(function(value) {
                    var display = value ? JSON.stringify(value, null, 2) : "None";
                    document.getElementById("test1-value").textContent = display;
                });
            }
            
            // Subscribe to test 2 changes
            if (widgets.test2 && widgets.test2.selectedEntities) {
                widgets.test2.selectedEntities.subscribe(function(values) {
                    var display = values.length > 0 ? 
                        values.map(function(e) { return e.displayName || e.firstName + " " + e.lastName; }).join(", ") : 
                        "None";
                    document.getElementById("test2-value").textContent = display;
                });
            }
            
            // Subscribe to host model changes
            mockHostModel.clientOdsId.subscribe(function(value) {
                document.getElementById("test4-value").textContent = value || "None";
            });
        }
        
        // Test control functions
        function setHostValue(value) {
            mockHostModel.clientOdsId(value);
            logToConsole("Host model value set to: " + value);
        }
        
        function toggleEnabled() {
            if (widgets.test4 && widgets.test4.options._host.enabled) {
                var current = widgets.test4.options._host.enabled();
                widgets.test4.options._host.enabled(!current);
                logToConsole("Widget enabled state: " + !current);
            }
        }
        
        function validateWidget() {
            if (widgets.test4 && widgets.test4.validate) {
                var isValid = widgets.test4.validate();
                logToConsole("Widget validation: " + (isValid ? "VALID" : "INVALID"));
                alert("Widget is " + (isValid ? "valid" : "invalid"));
            }
        }
        
        function saveWidget() {
            if (widgets.test4) {
                var model = {};
                
                if (widgets.test4.onBeforeSave) {
                    var canSave = widgets.test4.onBeforeSave(model);
                    logToConsole("onBeforeSave returned: " + canSave);
                }
                
                if (widgets.test4.onSave) {
                    widgets.test4.onSave(model);
                    logToConsole("onSave called, model: " + JSON.stringify(model));
                }
                
                if (widgets.test4.onAfterSave) {
                    widgets.test4.onAfterSave(model);
                    logToConsole("onAfterSave called");
                }
            }
        }
        
        // Console output helper
        function logToConsole(message) {
            var output = document.getElementById("console-output");
            if (output) {
                var time = new Date().toLocaleTimeString();
                var line = document.createElement("div");
                line.textContent = "[" + time + "] " + message;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }
        }
    </script>
    
    <!-- Load widget CSS -->
    <link rel="stylesheet" href="/_ideFiles/Alt/UnifiedDataSearch/Widgets/UnifiedOdsEntityPicker/UnifiedOdsEntityPicker.css">
</body>
</html>